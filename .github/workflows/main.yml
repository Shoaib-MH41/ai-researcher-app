name: Diagnostic Flutter Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  diagnostic-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.22.2'
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
    
    # üîç PHASE 1: PROJECT STRUCTURE DIAGNOSIS
    - name: Project Structure Analysis
      id: structure-check
      run: |
        echo "=== PROJECT STRUCTURE DIAGNOSIS ==="
        
        # Check essential files
        if [ ! -f "pubspec.yaml" ]; then
          echo "‚ùå ERROR: pubspec.yaml missing"
          exit 1
        fi
        
        if [ ! -d "lib" ]; then
          echo "‚ùå ERROR: lib/ directory missing"
          exit 1
        fi
        
        if [ ! -d "android" ]; then
          echo "üü° WARNING: android/ directory missing - will be created"
        fi
        
        echo "‚úÖ Basic project structure OK"
        
    # üîç PHASE 2: FLUTTER ENVIRONMENT CHECK
    - name: Flutter Environment Diagnosis
      id: flutter-check
      run: |
        echo "=== FLUTTER ENVIRONMENT DIAGNOSIS ==="
        flutter doctor -v
        flutter --version
        
        # Check if project needs initialization
        if [ ! -f "android/app/src/main/AndroidManifest.xml" ]; then
          echo "üü° Project not fully initialized, running flutter create..."
          flutter create --org com.example --project-name ai_researcher_app --platforms android . --overwrite
        fi
        
    # üîç PHASE 3: CODE ANALYSIS
    - name: Static Code Analysis
      id: code-analysis
      run: |
        echo "=== STATIC CODE ANALYSIS ==="
        flutter analyze --no-pub --write=analysis_results.json || true
        
        # Show analysis results
        if [ -f "analysis_results.json" ]; then
          echo "Analysis Results:"
          cat analysis_results.json | jq '.diagnostics[] | select(.severity == "ERROR")' || echo "No critical errors found"
        fi
        
    # üîç PHASE 4: DEPENDENCIES CHECK
    - name: Dependencies Diagnosis
      id: deps-check
      run: |
        echo "=== DEPENDENCIES DIAGNOSIS ==="
        flutter pub get
        
        # Check for dependency conflicts
        flutter pub deps --style=tree > dependency_tree.txt
        echo "Dependency tree generated"
        
    # üîç PHASE 5: GRADLE BUILD DIAGNOSIS
    - name: Android Gradle Diagnosis
      id: gradle-check
      run: |
        echo "=== ANDROID GRADLE DIAGNOSIS ==="
        
        cd android
        
        # Check Gradle configuration
        ./gradlew clean --info 2>&1 | tee gradle_clean.log || echo "Gradle clean completed with warnings"
        
        # Analyze Gradle logs for specific issues
        if grep -q "ERROR" gradle_clean.log; then
          echo "‚ùå GRADLE ERRORS FOUND:"
          grep -i "error" gradle_clean.log | head -10
          exit 1
        fi
        
        cd ..
        
    # üîç PHASE 6: BUILD WITH DETAILED LOGGING
    - name: Detailed Build Analysis
      id: build-analysis
      run: |
        echo "=== DETAILED BUILD ANALYSIS ==="
        
        # Build with maximum verbosity
        flutter build apk --debug --verbose 2>&1 | tee build_debug.log || true
        
        # Analyze build logs
        echo "=== BUILD LOG ANALYSIS ==="
        
        if grep -q "error:" build_debug.log; then
          echo "‚ùå BUILD ERRORS:"
          grep -i "error:" build_debug.log | head -15
        fi
        
        if grep -q "exception" build_debug.log; then
          echo "‚ùå EXCEPTIONS:"
          grep -i "exception" build_debug.log | head -10
        fi
        
        if grep -q "fail" build_debug.log; then
          echo "üü° BUILD WARNINGS:"
          grep -i "fail" build_debug.log | head -10
        fi
        
        # Check if APK was generated
        if find build/ -name "*.apk" -type f | grep -q .; then
          echo "‚úÖ APK GENERATED SUCCESSFULLY"
          find build/ -name "*.apk" -type f
        else
          echo "‚ùå NO APK GENERATED - Checking reasons..."
          # Look for compilation failures
          tail -50 build_debug.log
          exit 1
        fi
        
    # üîç PHASE 7: FINAL VERIFICATION
    - name: Final Verification
      id: final-check
      run: |
        echo "=== FINAL VERIFICATION ==="
        
        # Verify APK integrity
        APK_PATH=$(find build/ -name "*.apk" -type f | head -1)
        if [ -n "$APK_PATH" ]; then
          echo "‚úÖ APK Found: $APK_PATH"
          ls -la "$APK_PATH"
          echo "APK Size: $(du -h "$APK_PATH" | cut -f1)"
        else
          echo "‚ùå CRITICAL: No APK found after successful build"
          exit 1
        fi
        
    # ‚úÖ SUCCESS: UPLOAD ARTIFACTS
    - name: Upload APK Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: medical-research-app
        path: build/app/outputs/flutter-apk/app-debug.apk
        
    # üìã UPLOAD DIAGNOSTIC REPORTS
    - name: Upload Diagnostic Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-diagnostics
        path: |
          build_debug.log
          gradle_clean.log
          analysis_results.json
          dependency_tree.txt
