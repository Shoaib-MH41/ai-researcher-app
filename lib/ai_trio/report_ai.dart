import 'dart:convert';
import 'package:flutter/foundation.dart';
import '../models/research_model.dart';
import '../utils/pdf_generator.dart';

/// ğŸ§  ReportAI â€”
/// ÛŒÛ Ù…Ø§ÚˆÛŒÙˆÙ„ ØªÙ…Ø§Ù… AI Ù…Ø§ÚˆÛŒÙˆÙ„Ø² Ú©Û’ Ù†ØªØ§Ø¦Ø¬ Ù„Û’ Ú©Ø± Ø§Ù†ÛÛŒÚº
/// Ø§ÛŒÚ© Ù…Ú©Ù…Ù„ Ø±Ù¾ÙˆØ±Ù¹ Ø§ÙˆØ± PDF Ù…ÛŒÚº ØªØ¨Ø¯ÛŒÙ„ Ú©Ø±ØªØ§ ÛÛ’Û”
class ReportAI {
  /// ğŸ”¹ Ù…Ú©Ù…Ù„ Ø±Ù¾ÙˆØ±Ù¹ Ø¨Ù†Ø§Ù†Ø§ (Text + PDF Ø¯ÙˆÙ†ÙˆÚº)
  static Future<Map<String, dynamic>> generateCompleteReport({
    required String topic,
    required String hypothesis,
    required String researchSummary,
    required dynamic labResults,
    required dynamic medicalAnalysis,
    required dynamic treatmentPlan,
    required dynamic biologicalFindings,
  }) async {
    try {
      debugPrint("ğŸ§© [ReportAI] Generating full report for $topic...");

      // Step 1: Text Summary ØªÛŒØ§Ø± Ú©Ø±Ù†Ø§
      final StringBuffer reportBuffer = StringBuffer();
      reportBuffer.writeln("ğŸ§¬ AI Research Report");
      reportBuffer.writeln("==============================\n");
      reportBuffer.writeln("Topic: $topic\n");
      reportBuffer.writeln("Hypothesis: $hypothesis\n");
      reportBuffer.writeln("Research Summary:\n$researchSummary\n");
      reportBuffer.writeln("Lab Results:\n${jsonEncode(labResults)}\n");
      reportBuffer.writeln("Medical Analysis:\n${jsonEncode(medicalAnalysis)}\n");
      reportBuffer.writeln("Treatment Plan:\n${jsonEncode(treatmentPlan)}\n");
      reportBuffer.writeln("Biological Findings:\n${jsonEncode(biologicalFindings)}\n");
      reportBuffer.writeln("==============================\n");
      reportBuffer.writeln("ğŸ“… Generated by AI Researcher at ${DateTime.now()}");

      final textReport = reportBuffer.toString();

      // Step 2: PDF ØªÛŒØ§Ø± Ú©Ø±Ù†Ø§
      final pdfPath = await PdfGenerator.generateResearchPDF(
        research: MedicalResearch(
          id: DateTime.now().millisecondsSinceEpoch.toString(),
          topic: topic,
          hypothesis: hypothesis,
          methodology: "AI Orchestrated Multi-Agent Research",
          labResults: labResults,
          analysis: medicalAnalysis,
          conclusion: "AI-generated comprehensive report",
          pdfReport: "",
          createdAt: DateTime.now(),
          isAIResearch: true,
          aiDiscoveryData: {
            "summary": researchSummary,
            "lab": labResults,
            "analysis": medicalAnalysis,
            "cure": treatmentPlan,
            "bio": biologicalFindings,
          },
        ),
        reportText: textReport,
      );

      // Step 3: Ù…Ú©Ù…Ù„ ÚˆÛŒÙ¹Ø§ Ø±ÛŒÙ¹Ø±Ù†
      final Map<String, dynamic> result = {
        "summary": textReport,
        "pdf": pdfPath,
      };

      debugPrint("âœ… [ReportAI] Report generated successfully!");
      return result;
    } catch (e, st) {
      debugPrint("âŒ [ReportAI] Error generating report: $e\n$st");
      return {
        "summary": "Error generating report",
        "pdf": null,
      };
    }
  }

  /// âš™ï¸ ØµØ±Ù PDF Ø±Ù¾ÙˆØ±Ù¹ Ø¨Ù†Ø§Ù†Ø§ (Ø§Ú¯Ø± Ù¾ÛÙ„Û’ Ø³Û’ Text Ù…ÙˆØ¬ÙˆØ¯ ÛÙˆ)
  static Future<String> generatePDFReport({
    required MedicalResearch research,
    required String reportText,
  }) async {
    try {
      final pdfPath = await PdfGenerator.generateResearchPDF(
        research: research,
        reportText: reportText,
      );
      return pdfPath;
    } catch (e) {
      debugPrint("âŒ [ReportAI] Failed to generate PDF: $e");
      return '';
    }
  }
}
